#!/bin/bash

usage() {
  cat << HERE
Wrapper to control ssh-agent.

  ${0##*/} start   Start ssh-agent or print into to attach to it
  ${0##*/} stop    Stop the running ssh-agent keychain
  ${0##*/} status  Print status information

  -h        Show this message
  -e --env  Override where the environment file will be stored.
HERE
  exit ${1:-0}
}

env="$HOME/.ssh/environment-$HOSTNAME"
options=$(getopt -o he: -l help,env: -- "$@") || usage >&2 1

eval set -- $options
while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help) usage    ;;
    -e|--env)  env="$2" ;;

    --) shift; break    ;;
    -*) echo >&2 "$0: error - unrecognized option $1"; usage >&2 1 ;;
  esac
  shift
done

# start ssh-agent and setup environment
start_agent() {
  [[ -n $SSH_AGENT_PID ]] && ps -p $SSH_AGENT_PID >/dev/null && return

  ssh-agent >"$env"
  chmod 600 "$env"
  source "$env" >/dev/null
  ssh-add
}

[[ -f "$env" ]] && source "$env" >/dev/null

case "$1" in
  start)
    start_agent
    cat "$env"
    ;;
  stop)
    [[ -f "$env"         ]] && rm "$env"
    [[ -n $SSH_AGENT_PID ]] && ssh-agent -k
    ;;
  status)
    [[ -f "$env" ]] && echo "Agent is running (pid $SSH_AGENT_PID)" \
                    || echo "Agent isn't running"
    ;;
  *)
    echo  >&2 "$0: error - invalid command $1"
    usage >&2 1
    ;;
esac
